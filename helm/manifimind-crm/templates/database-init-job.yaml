{{- if .Values.database.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "manifimind-crm.fullname" . }}-db-init
  labels:
    app: {{ include "manifimind-crm.name" . }}
    component: db-init
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  template:
    metadata:
      labels:
        app: {{ include "manifimind-crm.name" . }}
        component: db-init
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-database
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          until pg_isready -h {{ include "manifimind-crm.fullname" . }}-database -p 5432 -U {{ .Values.database.env.POSTGRES_USER }}; do
            echo "Waiting for database..."
            sleep 2
          done
          echo "Database is ready"
      containers:
      - name: db-init
        image: "{{ .Values.global.registry }}/{{ .Values.database.image.repository }}:{{ .Values.database.image.tag }}"
        imagePullPolicy: {{ .Values.global.imagePullPolicy }}
        env:
        - name: PGHOST
          value: {{ include "manifimind-crm.fullname" . }}-database
        - name: PGPORT
          value: "5432"
        - name: PGUSER
          value: {{ .Values.database.env.POSTGRES_USER | quote }}
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "manifimind-crm.fullname" . }}-secrets
              key: db-password
        - name: PGDATABASE
          value: {{ .Values.database.env.POSTGRES_DB | quote }}
        command:
        - sh
        - -c
        - |
          set -e
          echo "Checking if database is initialized..."

          # Check if sec_accounts table exists
          if psql -tAc "SELECT 1 FROM information_schema.tables WHERE table_name='sec_accounts'" | grep -q 1; then
            echo "Database already initialized - tables exist"
            exit 0
          fi

          echo "Database not initialized - running initialization scripts..."

          # Run initialization scripts in order
          echo "Running schema initialization..."
          psql -f /docker-entrypoint-initdb.d/01-init.sql

          echo "Loading seed data..."
          psql -f /docker-entrypoint-initdb.d/02-load.sql

          echo "Running cleanup scripts..."
          psql -f /docker-entrypoint-initdb.d/03-truncate.sql

          echo "Database initialization complete!"
{{- end }}
